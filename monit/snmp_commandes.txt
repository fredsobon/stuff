=== notes diverses sur cmds snmp ==

https://blog.cedrictemple.net/239-faire-des-requetes-snmp-en-ligne-de-commande-sous-linux




= DIFFÃ‰RENCE ENTRE SNMPGET ET SNMPWALK

Aujourdâ€™hui, nous allons voir comme faire des requÃªtes SNMP en ligne de commande sur un systÃ¨me Linux. Lâ€™idÃ©e nâ€™est pas simplement de comprendre lâ€™utilisation des commandes standards snmpget et snmpwalk mais dâ€™aller un peu plus loin. En effet, comme vous pouvez le remarquer, je suis un vieux con : jâ€™adore la ligne de commande. Les commandes recÃ¨lent tant et tant dâ€™options quâ€™il est difficile de faire plus efficace et puissant. Nous verrons donc les options que vous nâ€™utilisez peut-Ãªtre pas mais aussi nous verrons dâ€™autres commandes. Lâ€™idÃ©e est de vous montrer que vous avez un vrai intÃ©rÃªt, tant dans lâ€™utilisation des options complÃ©mentaires que des autres commandes. Nous allons voir dans un premier temps les deux commandes standards : snmget et snmpwalk. Tout dâ€™abord, quelle est la diffÃ©rence entre snmget et snmpwalk?

En fait câ€™est simple : snmpget permet de rÃ©cupÃ©rer la valeur dâ€™un OID feuille alors que snmpwalk permet de rÃ©cupÃ©rer toutes les valeurs dâ€™un OID Â« noeud Â». Avec snmpget, vous rÃ©cupÃ©rez une et une seule valeur : la valeur de lâ€™OID demandÃ©. Si cet OID nâ€™est pas une feuille, vous nâ€™aurez pas de rÃ©ponse. snmpwalk permet de rÃ©cupÃ©rer toutes les valeurs dâ€™un sous-arbre : vous rÃ©cupÃ©rerez toutes les valeurs disponibles en dessous de lâ€™arbre.

ATTENTION : ne faites JAMAIS une requÃªte snmpwalk sur la racine de lâ€™arbre SNMP ou sur un noeud de haut niveau. Si vous faites cela, vous allez saturer lâ€™agent SNMP interrogÃ©, le rÃ©seau et votre poste. Dans le passÃ©, vous pouviez saturer certains agents SNMP et il Ã©tait nÃ©cessaire de les redÃ©marrer voire de redÃ©marrer lâ€™Ã©quipement. Ce pourrait Ãªtre trÃ¨s gÃªnant si vous deviez demander Ã  lâ€™Ã©quipe rÃ©seau de redÃ©marrer un routeur.

Lâ€™utilisation des commandes snmpget et snmpwalk est exactement la mÃªme, leur syntaxe est identique. Seul lâ€™OID interrogÃ© va diffÃ©rer, selon que vous souhaitez interroger un sous-arbre ou un OID feuille. Pour faire une requÃªte, il vous suffit de taper pour snmpwalk:

snmpwalk -v <laversion> -c <lacommunaute> <adresseip> <oid>

Exemple :

snmpwalk -v 2c -c public 192.168.1.13 1.3.6.1.2.1.2.2.1.10

Si vous savez utiliser la commande snmpwalk, vous saurez utiliser snmpget. Câ€™est exactement la mÃªme syntaxe :

snmpget -v <laversion> -c <lacommunaute> <adresseip> <oid>
snmpget -v 2c -c public 192.168.1.13 1.3.6.1.2.1.2.2.1.10.1

La diffÃ©rence de rÃ©sultat entre snmpwalk et snmpget est flagrante. Avec snmpwalk, vous obtenez plusieurs rÃ©ponses. Avec snmpget, pour le mÃªme OID, vous nâ€™obtenez aucune rÃ©ponse mais vous obtenez une rÃ©ponse avec un oid feuille.
Options de sortie

snmpget et snmpwalk disposent dâ€™options complÃ©mentaires. Peu de personnes les utilisent, ce qui est dommage car certaines sont trÃ¨s utiles et vous apportent des informations complÃ©mentaires. Parfois mÃªme, certains ne savent pas quâ€™elles existent car ils nâ€™ont pas identifiÃ© la bonne documentation. GÃ©nÃ©ralement, sur Linux, pour avoir de la documentation sur une commande, on tape

man <nomdelacommande>

Câ€™est pareil pour ces commandes mais avec une subtilitÃ© : les options communes de toutes les commandes snmpget, snmpwalk mais aussi toutes les autres snmptable, snmpbulk, snmpdelta, â€¦ sont regroupÃ©es dans une seule et mÃªme page de man. Cette page de man est :

man snmpcmd

snmpcmd : cmd comme Â« commande Â»

Nous nâ€™allons pas dÃ©tailler toutes les options possibles mais noter celles qui sont intÃ©ressantes. Toutes les options dont je vais parler sont celles liÃ©es Ã  lâ€™affichage des rÃ©sultats. Une commande snmpwalk sans option de sortie particuliÃ¨re affiche ses rÃ©sultats en format raccourcit. Câ€™est Ã  dire que la commande nâ€™affiche pas le dÃ©but de lâ€™OID mais le nom de la MIB dans laquelle se trouve cet OID. Ceci est fait pour simplifier la lecture et raccourcir lâ€™affichage. Cependant, il peut Ãªtre intÃ©ressant dâ€™avoir lâ€™OID complet. Pour cela, câ€™est trÃ¨s simple, il suffit dâ€™ajouter lâ€™option O (en majuscule), O comme output suivi dâ€™un f (minuscule), f comme Â« full Â». La ligne de commande devient donc:

snmpwalk -v 2c -c public -Of 192.168.1.13 1.3.6.1.2.1.2.2.1.10

Vous avez alors lâ€™OID complÃ¨tement affichÃ©.

Les commandes font de la traduction automatiquement. Cette traduction est faite en entrÃ©e, câ€™est Ã  dire lorsque vous saisissez un OID au format alphanumÃ©rique sur la ligne de commande puis en sortie, lors de lâ€™affichage. Cette traduction nâ€™est possible que si la MIB est prÃ©sente sur le systÃ¨me et que le systÃ¨me est configurÃ© pour lire ces MIBs. Cependant, pour amÃ©liorer les performances, il est toujours prÃ©fÃ©rable dâ€™Ã©viter cette traduction. Notamment, dans les scripts, il est toujours prÃ©fÃ©rable de saisir les OID au format numÃ©rique et de demander aux commandes de ne sortir les rÃ©sultats quâ€™au format numÃ©rique.

Lâ€™option permettant dâ€™afficher les OIDs au format numÃ©rique est O (majuscule), O comme Â« output Â», suivi de n (minuscule), n comme Â« numeric Â». La ligne de commande devient donc:

snmpwalk -v 2c -c public -On 192.168.1.13 1.3.6.1.2.1.2.2.1.1

Lâ€™option suivante vous permet dâ€™afficher la valeur de lâ€™OID sans rappeler lâ€™OID. Jâ€™utilise personnellement cette option lorsque jâ€™interroge un agent snmp depuis un script afin de simplifier le dÃ©veloppement du script. En effet, il est dÃ©sagrÃ©able (et peu performant) de devoir parser le rÃ©sultat de la commande Ã  coup de grep/awk/sed ou autre alors quâ€™on peut lâ€™Ã©viter. Cette option est Â« Ov Â», O majuscule comme Output et v (minuscule) comme value only

snmpwalk -v 2c -c public -Ov 192.168.1.13 1.3.6.1.2.1.2.2.1.1

Une autre option que jâ€™utilise dans les scripts, est le e minuscule. Cette option permet dâ€™Ã©viter une traduction de la valeur de lâ€™OID. La valeur dâ€™un OID est gÃ©nÃ©ralement un entier et cet entier correspond Ã  un code dâ€™erreur. La MIB SNMP dÃ©finit cette traduction et la commande lâ€™interprÃ¨te. Par exemple, lâ€™OID correspondant Ã  IP Forwarding dispose du code suivant:

1 ==> Forwarding
2 ==> not forwarding.

Pour Ã©viter que la commande ne traduise automatiquement cette valeur et remplace 1 par Â« forwarding Â», ce qui serait plus complexe Ã  parser pour un script, il vous suffit dâ€™utiliser lâ€™option Oe. Enfin, pour disposer dâ€™un rÃ©sultat totalement pur, il faut ajouter un Q pour ne pas afficher le type de la rÃ©ponse.

Au final, la commande devient:

snmpwalk -v 2c -c public -OevQ 192.168.1.13 ipForwarding.0

=== SNMPTABLE

Ce que beaucoup ignorent, câ€™est que les OIDs sont organisÃ©s sous forme dâ€™un tableau. Prenons un exemple : les connexions TCP sur un serveur. Une connexion TCP dispose de plusieurs informations : son statut, lâ€™adresse IP locale, le port TCP local, lâ€™adresse IP distante et le port TCP distant. Chaque information correspond Ã  1 OID. Et il faut ajouter Ã  chacun des OIDs le numÃ©ro de la connexion. Si on utilise la commande SNMPWALK, le rÃ©sultat est trÃ¨s peu lisible. Le rÃ©sultat est organisÃ© par OID et non par connexion. Par contre, en utilisant la commande snmptable, la prÃ©sentation des rÃ©sultats va Ãªtre amÃ©liorÃ©e par la commande. PlutÃ´t que de prÃ©senter les OIDs les uns Ã  la suite des autres, elle va les prÃ©senter sous forme de tableau : chaque connexion TCP sera sur une ligne et ses caractÃ©ristiques sur les colonnes. Beaucoup plus simple Ã  lire pour un humain normal.

snmptable -v 2c -c public localhost 1.3.6.1.2.1.6.13

Câ€™est Ã  dire, tout humain dont le nom nâ€™est pas Sheldon Cooper ;-). Quelques options peuvent Ãªtre passÃ©es Ã  la commande snmptable. Deux options que je vous recommande. La premiÃ¨re est -Ci et affiche lâ€™index. Cela peut Ãªtre intÃ©ressant pour lâ€™utiliser dans la suite dâ€™un script.

snmptable -v 2c -c public -Ci localhost 1.3.6.1.2.1.6.13

La seconde est -Cb et elle affiche les entÃªtes de colonne sous forme courte. Les entÃªtes sont alors plus lisibles.

snmptable -v 2c -c public -Cb localhost 1.3.6.1.2.1.6.13

De nombreux OIDs sont organisÃ©s sous forme de tableau : les partitions, les interfaces rÃ©seaux, la charge des processeurs, la liste des processus, les filesystÃ¨mes, les mÃ©triques de performances des processus, â€¦ Cependant, attention : vous ne pourrez obtenir une prÃ©sentation sous forme de table que pour les OIDs qui â€¦ sont organisÃ©s sous forme de table. Cela apparaÃ®t Ã©vident mais Ã§a va mieux en le disant.



== Configuration avancÃ©e de SNMP sur Linux : redÃ©marrer un service Ã  distance en utilisant le protocole SNMP

 

Le dÃ©mon SNMP fourni par Net-SNMP vous permet de redÃ©marrer des services Ã  distance en utilisant le protocole SNMP. Nous allons voir comment le configurer pour:

    connaÃ®tre lâ€™Ã©tat dâ€™un service
    obtenir un dÃ©tail de statut
    redÃ©marrer le service concernÃ©.

Le terme Â« service Â» est utilisÃ© mais il est, en rÃ©alitÃ©, mal employÃ©. Sur Linux, un service peut lancer plusieurs processus. Câ€™est le cas du service postfix par exemple ou MySQL qui lance un script shell mysqld_safe et un processus mysqld. Avec Net-SNMP, nous allons pouvoir visualiser le nombre de processus correspondant Ã  un nom donnÃ©. En fonction de cela, nous allons redÃ©marrer un service donnÃ©.

Pourquoi permettre de redÃ©marrer un service Ã  lâ€™aide du protocole SNMP? Il est gÃ©nÃ©ralement prÃ©fÃ©rable de rÃ©aliser cette action en se connectant en SSH sur le serveur et en redÃ©marrant directement le service concernÃ©. Cela apporte une plus grande souplesse et un meilleur contrÃ´le : on obtient le code de retour mais aussi un affichage textuel qui fournit de plus amples dÃ©tails permettant de comprendre le code de retour. En SNMP, avec Net-SNMP, seul le code de retour sera fourni. Pourquoi alors utiliser SNMP? En rÃ©alitÃ©, ce nâ€™est pas mis en place. Pas avec lâ€™aide du protocole SNMP. Sauf dans un cas prÃ©cis : lorsque les administrateurs ne donnent aucun Â« accÃ¨s direct Â» (comprendre : pas de compte Unix) aux serveurs pour toute personne extÃ©rieure. Lâ€™Ã©quipe supervision est parfois extÃ©rieure Ã  lâ€™Ã©quipe des administrateurs. Ce qui a des avantages comme des inconvÃ©nients (tiensâ€¦ il faudrait que jâ€™Ã©crive un article sur ce sujetâ€¦..). DÃ¨s lors, il est possible de sâ€™entendre avec lâ€™Ã©quipe dâ€™administrateurs pour redÃ©marrer certains services clairement identifiÃ©s, en utilisant le protocole SNMP. La configuration de ces services doit Ãªtre rÃ©alisÃ©e sur les serveurs : elle peut Ãªtre totalement contrÃ´lÃ©e par lâ€™Ã©quipe dâ€™administration. Lâ€™Ã©quipe dâ€™administration est donc rassurÃ©e sur les actions rÃ©alisÃ©es par lâ€™Ã©quipe de supervision car câ€™est elle qui les contrÃ´le totalement. Maintenant, nous allons voir comment configurer le dÃ©mon Net-SNMP pour lui faire redÃ©marrer un service Ã  lâ€™aide du protocole SNMP.

Nous reprenons le fichier de configuration de Net-SNMP prÃ©cÃ©dent:

syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%
rouser ctemple
informsink 192.168.1.1 secrete
authtrapenable 1
agentSecName ctemple
defaultMonitors yes
linkUpDownNotifications yes

Nous pouvons ajouter une ligne indiquant quel est le processus qui sera automatiquement supervisÃ© par Net-SNMP:

proc apache2 100 2

Cette ligne indique quâ€™il doit y avoir au moins deux processus nommÃ© apache2 et pas plus de 100. Si tel est le cas, une trap SNMP sera envoyÃ©e automatiquement Ã  notre rÃ©cepteur prÃ©cÃ©demment configurÃ©. AprÃ¨s avoir redÃ©marrÃ© le service snmpd, les informations sur le statut sont disponibles dans la MIB Net-SNMP (branche Â« enterprisesâ€“>ucdavis Â» pour Ãªtre prÃ©cis) et accessibles avec un snmptable en interrogeant lâ€™OID .1.3.6.1.4.1.2021.2 :

cedric@monserveur:$ snmptable -v 3 -u ctemple -a SHA -A 'MonMot2Passe!!' -x AES -X '!!MaPhrase2PasseAE' -l authPriv localhost 1.3.6.1.4.1.2021.2
SNMP table: UCD-SNMP-MIB::prTable

 prIndex prNames prMin prMax prCount prErrorFlag prErrMessage prErrFix prErrFixCmd
       1 apache2     2   100       4     noError               noError

Le tableau prÃ©sentÃ© indique:

    lâ€™index du processus supervisÃ© (valeur : 1)
    le nom du processus supervisÃ© : apache2
    le nombre minimum de processus devant Ãªtre prÃ©sent : 2
    le nombre maximum de processus devant Ãªtre prÃ©sent : 100
    le nombre minimum de processus prÃ©sents actuellement : 4
    un drapeau dâ€™erreur : noError (pas dâ€™erreur donc!)
    un message dâ€™erreur : pas dâ€™erreur donc le message est vide
    un drapeau de correction dâ€™erreur : noError (pas dâ€™erreur donc!)
    la commande lancÃ©e pour corriger lâ€™erreur : aucune commande configurÃ©e

AprÃ¨s avoir arrÃªtÃ© Apache, voici le rÃ©sultat de la commande:

SNMP table: UCD-SNMP-MIB::prTable

 prIndex prNames prMin prMax prCount prErrorFlag                    prErrMessage prErrFix prErrFixCmd
       1 apache2     2   100       0       error Too few apache2 running (# = 0)  noError

LÃ , nous pouvons observer que le nombre de processus mesurÃ© est de 0, quâ€™il y a un drapeau dâ€™erreur (Â« errorÂ« ) et un message dâ€™erreur (Â« Too few apache2 running (# = 0)Â« ). Maintenant, voyons comment faire en sorte de redÃ©marrer le service Apache Ã  distance. Tout dâ€™abord, nous devons ajouter une ligne dans le fichier /etc/snmp/snmpd.conf qui va corriger le problÃ¨me :

procfix apache2 /etc/init.d/apache2 restart

Nous avons une ligne Â« procfix Â» avec deux arguments:

    le nom du processus qui est supervisÃ©. Attention : ce nom doit Ãªtre exactement identique Ã  la ligne Â« proc Â» prÃ©cÃ©dente.
    la commande de correction de lâ€™erreur. Dans notre cas, nous avons fait trÃ¨s simple : nous redÃ©marrons tout simplement le service apache2.

Voyons dorÃ©navant le rÃ©sultat de l'appel Ã  snmptable aprÃ¨s avoir redÃ©marrÃ© le service snmpd :

SNMP table: UCD-SNMP-MIB::prTable

 prIndex prNames prMin prMax prCount prErrorFlag                    prErrMessage prErrFix                 prErrFixCmd
       1 apache2     2   100       0       error Too few apache2 running (# = 0)  noError /etc/init.d/apache2 restart

Nous pouvons voir que prErrFixCmd contient la commande configurÃ©e, que nous pourrons utiliser pour redÃ©marrer apache. Pour donner lâ€™ordre Ã  snmpd dâ€™exÃ©cuter cette commande, il faut utiliser la commande snmpset. La commande snmpset permet de mettre Ã  jour un OID. Le dÃ©mon snmpd de Net-SNMP fournit pour chaque ligne procfix (correctement configurÃ©e) un OID Ã  mettre Ã  jour : il sâ€™agit de prErrFix. prErrFix est un drapeau dont la valeur est toujours 0 mais que lâ€™on peut passer Ã  1 Ã  lâ€™aide dâ€™une commande snmpset. Lorsque cette valeur est passÃ© Ã  1, la commande configurÃ©e est exÃ©cutÃ©e.

Dans SNMPb, il est possible de faire un snmpset. Pour cela, il faut se rendre dans la MIB dÃ©diÃ©e, OID .1.3.6.1.4.1.2021.2.1.102 puis faire un clic droit et cliquer sur Â« Setâ€¦ Â» (cliquer sur lâ€™image pour lâ€™agrandir) :
snmpb : snmpset dans prtable de Net-SNMP
snmpb : snmpset dans prtable de Net-SNMP

SNMPb vous indique alors la liste des index disponibles. Dans notre cas, nous nâ€™avons quâ€™un seul valeur : 1. Nous pouvons donc choisir 1 (cliquer sur lâ€™image pour lâ€™agrandir):
snmpb : snmpset dans prtable pour Net-SNMP: choisir index
snmpb : snmpset dans prtable pour Net-SNMP: choisir index

Une fois ceci fait, une nouvelle fenÃªtre apparaÃ®t nous permettant de saisir la valeur qui sera envoyÃ©e. LÃ  encore, SNMPb nous facilite le travail et nous indique l'on peut choisir la valeur 0 pour "noError" et la valeur 1 pour "runFix". Nous choisissons donc la valeur 1 et nous validons. Voici le rÃ©sultat aprÃ¨s avoir de nouveau relancer la commande snmptable:

SNMP table: UCD-SNMP-MIB::prTable
prIndex prNames prMin prMax prCount prErrorFlag                    prErrMessage prErrFix                 prErrFixCmd
       1 apache2     2   100       0       error Too few apache2 running (# = 0)   runFix /etc/init.d/apache2 restart

Nous pouvons constater que la valeur de prErrFix est passÃ©e Ã  runFix. Mais il ne se passe rien, malgrÃ© plusieurs minutes dâ€™attente. La raison est simple : le service Net-SNMP est exÃ©cutÃ© en tant quâ€™utilisateur Unix Â« snmp Â». Cet utilisateur nâ€™a pas le droit de lancer cette commande. Il faut donc lui donner les droits. Une premiÃ¨re mÃ©thode (sale mÃ©thodeâ€¦ prÃ©fÃ©rer plutÃ´t la configuration de sudo) est de configurer le dÃ©mon Net-SNMP pour quâ€™il prenne lâ€™identifiant root (pour Ãªtre exact : pour quâ€™il conserve les droits root lorsquâ€™il souhaite abandonner ses droits). Pour cela, il suffit dâ€™ajouter la ligne suivante au fichier /etc/snmp/snmpd.conf:

agentUser root

Une fois lâ€™agent Net-SNMP redÃ©marrÃ©, la commande snmpset peut Ãªtre relancÃ©e Ã  lâ€™aide de SNMPb. DÃ¨s lors, le service apache2 est immÃ©diatement relancÃ©:

SNMP table: UCD-SNMP-MIB::prTable

prIndex prNames prMin prMax prCount prErrorFlag prErrMessage prErrFix                 prErrFixCmd
       1 apache2     2   100       4     noError               noError /etc/init.d/apache2 restart

Il est aussi possible de se passer de SNMPb et de faire cela en ligne de commande grÃ¢ce Ã  snmpset : cela est trÃ¨s utile pour le faire dans un script. La commande est la suivante:

snmpset -v 3 -u ctemple -a SHA -A 'MonMot2Passe!!' -x AES -X '!!MaPhrase2PasseAE' -l authPriv  localhost 1.3.6.1.4.1.2021.2.1.102.1 i 1

Celle-ci est un peu longue, je vais la raccourcir pour mieux expliquer le sujet:

snmpset [informations snmpv3]  localhost 1.3.6.1.4.1.2021.2.1.102.1 i 1

En fait, la commande snmpset prend, en dehors des arguments standards pour mâ€™identifier en SNMPv3, les arguments suivants :

    lâ€™adresse IP ou le nom de domaine de lâ€™Ã©quipement
    lâ€™OID qui sera mis Ã  jour. Attention : cet OId doit contenir lâ€™index. Cet index est positionnÃ© en toute fin de lâ€™OID. Lâ€™OID de base est : 1.3.6.1.4.1.2021.2.1.102, auquel je dois ajouter lâ€™index, qui est Â« 1 Â».
    i correspond au type de donnÃ©es que jâ€™envoie. Dans notre cas, le type de donnÃ©es attendu est un Â« Integer32 Â» qui est reprÃ©sentÃ© par Â« i Â».
    la valeur envoyÃ©. Dans notre cas, runFix est Ã  la valeur 1.

Le fichier /etc/snmp/snmpd.conf complet est maintenant:

syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%
rouser ctemple
informsink 192.168.1.1 secrete
authtrapenable 1
agentSecName ctemple
defaultMonitors yes
linkUpDownNotifications yes
agentUser root
proc apache2 100 2
procfix apache2 /etc/init.d/apache2 restart


== Configuration avancÃ©e de SNMP sur Linux : les informations systÃ¨mes


Nous avons vu dans un article prÃ©cÃ©dent comment configurer lâ€™agent Net-SNMP afin quâ€™il rÃ©ponde Ã  nos requÃªtes. Nous allons voir maintenant comment configurer cet agent Net-SNMP pour quâ€™il supervise le serveur de lui-mÃªme.

Nous partons du fichier de configuration prÃ©cÃ©dent Ã  savoir:

rocommunity macommunaute
rwcommunity macommunauteRW 192.168.0.1
syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg

Avant toute chose

Toute la configuration se fait dans le fichier /etc/snmp/snmpd.conf.

Tout modification faite dans ce fichier nâ€™est propagÃ©e dans lâ€™agent quâ€™au redÃ©marrage de celui-ci. Pensez Ã  redÃ©marrer lâ€™agent Ã  chaque modification:

/etc/init.d/snmpd restart

Supervision de la load

Le premier indicateur que nous allons configurer est la load. Vous pouvez retrouver sur Wikipedia la dÃ©finition de la load. Attention : la load nâ€™est pas uniquement liÃ©e aux CPU (vous pouvez avoir une load de 180 avec un CPU trÃ¨s trÃ¨s peu utilisÃ©). Je vous expliquerai comment un jour prochain ;-). Comment configurer la supervision de la load:

load loadAveragemax1minutes loadAveragemax5minutes loadAveragemax15minutes

Exemple sur un serveur avec 4 coeurs :

load 16 8 4

Si la load avegarde sur 15 minutes est supÃ©rieure Ã  4 alors :

    jâ€™aurai une information dâ€™erreur dans la MIB SNMP
    jâ€™aurai une trap SNMP qui sera envoyÃ©e au serveur de supervision (configuration que nous mettrons en place plus tard)

AprÃ¨s sauvegarde du fichier et redÃ©marrage de lâ€™agent SNMP, je peux effectuer les requÃªtes:

[root@localhost ~]# snmptable -v 2c -c macommunaute 127.0.0.1 1.3.6.1.4.1.2021.10
SNMP table: UCD-SNMP-MIB::laTable

 laIndex laNames laLoad laConfig laLoadInt laLoadFloat laErrorFlag laErrMessage
       1  Load-1   1.76    16.00       176    1.760000           0             
       2  Load-5   1.72     8.00       171    1.720000           0             
       3 Load-15   0.92     4.00        92    0.920000           0

Si vous ne connaissez pas snmptable, je vous invite Ã  regarder ma vidÃ©o sur SNMPb. Dans le rÃ©sultat ci-dessus, on voit :

    dans la colonne Â« laConfig Â» (la == load average) la configuration mise en place
    la colonne Â« laLoadInt Â» donne la valeur de la load multipliÃ©e par 100
    la valeur Â« rÃ©elle Â» de la load est dans  les colonnes Â« laLoad Â» et Â« laLoadFloat Â»
    Enfin, les deux derniÃ¨res colonnes indiquent si lâ€™une des valeurs mesurÃ©es de la load dÃ©passe la valeur seuil correspondante configurÃ©e (laErrorFlog == 0 si la valeur nâ€™est pas dÃ©passÃ©e et laErrorFlag == 1 si la valeur est dÃ©passÃ©e) et le message dâ€™erreur correspondant (Â« laErrorMessage Â»).

Jâ€™ai artificiellement fait monter la load de ma machine virtuelle pour que la valeur de la load configurÃ©e soit dÃ©passÃ©e. Voici le rÃ©sultat:

 [root@localhost ~]# snmptable -v 2c -c macommunaute 127.0.0.1 1.3.6.1.4.1.2021.10
SNMP table: UCD-SNMP-MIB::laTable

 laIndex laNames laLoad laConfig laLoadInt laLoadFloat laErrorFlag                          laErrMessage
       1  Load-1  21.81    16.00      2180   21.809999           1 1 min Load Average too high (= 21.81)
       2  Load-5   8.27     8.00       826    8.270000           1  5 min Load Average too high (= 8.27)
       3 Load-15   3.42     4.00       341    3.420000           0

Ici, on voit que la load average sur 1 minute et la load average sur 5 minutes dÃ©passent toutes deux leurs valeurs seuils. On a donc pour chacune dâ€™elle le Â« laErrorFlag Â» qui passe Ã  1 et le Â« laErrMessage Â» qui donne le dÃ©tail de lâ€™erreur. Ces deux OIDs peuvent Ãªtre utilisÃ©s par une sonde de supervision, par exemple une sonde Nagios heu.. Shinkenâ€¦ heuâ€¦ Icingaâ€¦ heu Centreon-Engineâ€¦ heuâ€¦ Naemon. Bref!
Supervision des partitions

Pour superviser les partitions, il vous suffit dâ€™ajouter une directive de la forme:

disk /nom/partition espaceLibre

DÃ¨s lors, la partition Â« /nom/partition Â» doit avoir au moins Â« espaceLibre Â» kilo octets de disponible. Sinon, une erreur est prÃ©sente dans la MIB. Si vous ajoutez le sigle â€˜%â€™ en fin de ligne, la partition doit disposer dâ€™au moins Â« espaceLibre Â» % dâ€™espace libre. Voici un exemple de configuration:

disk / 10%

disk /boot 15000

Dans la configuration ci-dessus, la partition / doit disposer dâ€™au moins 10% dâ€™espace libre et la partition /boot doit disposer dâ€™au moins 15000 Ko dâ€™espace libre. Si vous souhaitez configurer le mÃªme espace libre pour toutes les partitions, il vous suffit de faire:

includeAllDisks 10%

Voici un exemple de requÃªte SNMP:

[root@localhost ~]# snmptable -v 2c -c macommunaute 127.0.0.1 1.3.6.1.4.1.2021.9
SNMP table: UCD-SNMP-MIB::dskTable

 dskIndex                  dskPath                       dskDevice dskMinimum dskMinPercent dskTotal dskAvail dskUsed dskPercent dskPercentNode dskTotalLow dskTotalHigh dskAvailLow dskAvailHigh dskUsedLow dskUsedHigh dskErrorFlag dskErrorMsg
        1                        / /dev/mapper/VolGroup00-LogVol00         -1            10  6284792  4548256 1412136         24              3     6284792            0     4548256            0    1412136           0            0            
        2                    /proc                            proc         -1            10        0        0       0          0            100           0            0           0            0          0           0            0            
        3                     /sys                           sysfs         -1            10        0        0       0          0            100           0            0           0            0          0           0            0            
        4                 /dev/pts                          devpts         -1            10        0        0       0          0            100           0            0           0            0          0           0            0            
        5                    /boot                       /dev/hda1         -1            10   101086    83428   12439         13              0      101086            0       83428            0      12439           0            0            
        6                 /dev/shm                           tmpfs         -1            10   436048   436048       0          0              0      436048            0      436048            0          0           0            0            
        7 /proc/sys/fs/binfmt_misc                            none         -1            10        0        0       0          0            100           0            0           0            0          0           0            0

Dans le rÃ©sultat ci-dessus, les colonnes sont les suivantes:

    dskPath : le nom du point de montage
    dskDevice : le nom de la partition
    dskMinimum : espace libre (en Ko) minimum configurÃ©, si la valeur mesurÃ©e est infÃ©rieur, une erreur sera gÃ©nÃ©rÃ©e. Dans notre cas, -1 est affichÃ© car nous nâ€™avons pas configurÃ© de valeur minimale en Ko mais en pourcentage
    dskMinPercent : pourcentage dâ€™espace libre minimum configurÃ©, si la valeur mesurÃ©e est infÃ©rieur, une erreur sera gÃ©nÃ©rÃ©e
    dskTotal : la taille de la partition (en ko)
    dskAvailable : lâ€™espace libre disponible (en ko)
    dskUSed : lâ€™espace occupÃ© (en ko)
    dskPercent : lâ€™espace occupÃ© (en %)
    dskPercentNode : le pourcentage dâ€™inodes occupÃ©
    dskErrorFlag : passe Ã  1 si la partition dÃ©passe sa valeur seuil, 0 sinon
    dskErrorMessage : dÃ©tail du message dâ€™erreur si la partition dÃ©passe sa valeur seuil

Supervision de processus

La supervision de processus se fait par la directive de configuration suivante:

proc nomProcessus maxPresent minPresent

Voici un exemple pour Apache:

proc httpd 100 2

Dans la configuration ci-dessus, nous avons fait en sorte que lâ€™agent SNMP supervise quâ€™il y ai au moins 2 processus httpd et pas plus de 100. Sâ€™il y a plus de 100 processus httpd ou moins de 2, une erreur sera prÃ©sente dans la MIB. Voici un exemple:

[root@localhost ~]# snmptable -v 2c -c macommunaute 127.0.0.1 1.3.6.1.4.1.2021.2
SNMP table: UCD-SNMP-MIB::prTable

 prIndex prNames prMin prMax prCount prErrorFlag                  prErrMessage prErrFix prErrFixCmd
       1   httpd     2   100       0           1 Too few httpd running (# = 0)        0

 

Dans le rÃ©sultat ci-dessus, on peut voir :

    le nom des processus supervisÃ©s (dans notre cas, un seul : httpd. Il est tout Ã  fait possible de superviser plusieurs processus en ajoutant plusieurs lignes)
    les valeurs seuils min et max configurÃ©es
    le nombre de processus mesurÃ© (Â« prCount Â» = 0)
    le flag dâ€™erreur (Â« prErrorFlag Â» = 1)
    le message dâ€™erreur (Â« pErrMessage Â»)

Supervision de la taille dâ€™un fichier

Lâ€™agent SNMP peut aussi superviser la taille dâ€™un fichier. Si la taille dÃ©passe une valeur seuil, une erreur est disponible dans la MIB. La configuration est la suivante:

file /var/log/syslog  153600

DÃ¨s lors, on peut vÃ©rifier par une requÃªte SNMP la taille de chaque fichier:

[root@localhost log]# snmptable -v 2c -c macommunaute 127.0.0.1 1.3.6.1.4.1.2021.15
SNMP table: UCD-SNMP-MIB::fileTable

fileIndex        fileName  fileSize   fileMax fileErrorFlag                                        fileErrorMsg
         1 /var/log/syslog 157473 kB 153600 kB          true /var/log/syslog: size exceeds 153600kb (= 157473kb)

Les colonnes sont les suivantes:

    le nom du fichier (Â« filename Â»)
    sa taille (Â« fileSize Â»)
    la taille maximale autorisÃ©e (Â« fileMax Â»)
    si le fichier dÃ©passe la taille maximale autorisÃ©e (Â« fileErrorFlag Â» = true (et non 1!!!))
    le dÃ©tail de lâ€™erreur (Â« fileErrorMsg Â»)


== Configuration avancÃ©e de SNMP sur Linux : SNMPv3
 
Il existe plusieurs versions du protocole SNMP dont les principales sont :

    SNMPv1
    SNMPv2c
    SNMPv3

Les versions v1 et v2c sont les versions les plus utilisÃ©es et les plus rÃ©pandues. Cependant, ces deux versions ont toutes les deux les mÃªmes problÃ¨mes:

    les trames circulent en clair sur le rÃ©seau. Aucun chiffrement des trames nâ€™est en place. Tout attaquant qui rÃ©ussit Ã  Ã©couter le rÃ©seau Ã  un endroit stratÃ©gique (pas sur le rÃ©seau bureautique en gÃ©nÃ©ral) peut rÃ©cupÃ©rer la communautÃ© SNMP. La communautÃ© SNMP ne suffit pas forcÃ©ment : lâ€™agent peut Ãªtre configurÃ© pour ne rÃ©pondre quâ€™Ã  des requÃªtes provenant de certaines adresses IP. De plus, un parefeu peut Ãªtre mis en place et configurÃ© pour nâ€™autoriser les requÃªtes SNMP quâ€™aux serveurs de supervision. Mais le spoofing dâ€™adresse IP est toujours possible.
    il nâ€™y a pas de notion dâ€™Â« utilisateur authentifiÃ© Â». La communautÃ© SNMP est gÃ©nÃ©ralement connue de tous les administrateurs systÃ¨mes et rÃ©seaux. Il est possible de scinder les Ã©quipements selon leur type et dâ€™affecter une communautÃ© SNMP diffÃ©rente selon le type de lâ€™Ã©quipement (exemple : tous les serveurs Linux ont une communautÃ©, celle-ci est diffÃ©rente des Ã©quipements rÃ©seaux) mais ce nâ€™est pas pratique.

GÃ©nÃ©ralement, lors dâ€™un dÃ©ploiement de SNMPv1 et SNMPv2c, aucune technique de sÃ©curisation de ces protocoles nâ€™est rÃ©alisÃ©e car aucun mÃ©canisme ne le permet rÃ©ellement. Alors, la sÃ©curisation en pÃ©riphÃ©rie du protocole doit Ãªtre rÃ©alisÃ©e (filtrage Ã  diffÃ©rents niveaux, mÃ©canisme anti-spoofing, â€¦).

Le protocole SNMPv3 permet de rÃ©pondre Ã  ces deux enjeux:

    les trames peuvent Ãªtre chiffrÃ©es grÃ¢ce Ã  diffÃ©rents protocoles algorithmes (*).
    des utilisateurs peuvent Ãªtre crÃ©Ã©s, chacun disposant dâ€™un identifiant et dâ€™un mot de passe personnel.

La sÃ©curitÃ© de SNMPv3 est bien supÃ©rieure Ã  celle de SNMPv1 et SNMPv2c. A contrario, sa mise en place est moins aisÃ©e. Nous allons voir les Ã©tapes pour configurer lâ€™agent Net-SNMP sur Linux, tant sur Debian et CentOS/RedHat.

Nous repartons du fichier de configuration initial Ã  savoir:

rocommunity macommunaute
rwcommunity macommunauteRW 192.168.0.1
syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%

La premiÃ¨re chose est dâ€™arrÃªter SNMP:

/etc/init.d/snmpd stop

Avez vous bien arrÃªter le service SNMP? Oui? SÃ»r? Câ€™est important pour la suite! Ensuite, ajouter un utilisateur dans le fichier /etc/snmp/snmpd.conf:

rouser ctemple

Cet utilisateur va par la suite pouvoir sâ€™authentifier. Pour cela, il faut ajouter une information dans un fichier spÃ©cifique. Ce fichier spÃ©cifique va Ãªtre lu par le service SNMP, interprÃ©tÃ© puis modifiÃ© afin de ne pas conserver la clÃ© et le mot de passe en clair. Attention, si vous nâ€™avez pas arrÃªtÃ© le service SNMP, ce fichier va Ãªtre Ã©crasÃ© : toutes les modifications faites seront perdues. Il est donc nÃ©cessaire dâ€™arrÃªter le service SNMP avant dâ€™Ã©diter ce fichier. Ce fichier est particulier car il contient des informations Ã  ne pas modifier. Il faut donc ajouter une ligne comme suit dans le fichier /var/net-snmp/snmpd.conf pour CentOS/RedHat et dans le fichier /var/lib/snmp/snmpd.conf pour Debian :

createUser ctemple SHA MonMot2Passe!! AES !!MaPhrase2PasseAES

Un utilisateur va avoir les caractÃ©ristiques suivantes:

    un identifiant : ctemple
    un algorithme de hachage du mot de passe : SHA (MD5 est disponible)
    un mot de passe : MonMot2Passe!!
    un algorithme de chiffrement des trames ; AES (DES est disponible)
    une clÃ© de chiffrement des trames : !!MaPhrase2PasseAES

Cette ligne doit Ãªtre ajoutÃ©e dans le fichier comme indiquÃ© ci-dessous:

#
# net-snmp (or ucd-snmp) persistent data file.
#
############################################################################
# STOP STOP STOP STOP STOP STOP STOP STOP STOP
#
#          **** DO NOT EDIT THIS FILE ****
#
# STOP STOP STOP STOP STOP STOP STOP STOP STOP
############################################################################
#
# DO NOT STORE CONFIGURATION ENTRIES HERE.
# Please save normal configuration tokens for snmpd in SNMPCONFPATH/snmpd.conf.
# Only "createUser" tokens should be placed here by snmpd administrators.
# (Did I mention: do not edit this file?)
#
createUser ctemple SHA MonMot2Passe!! AES !!MaPhrase2PasseAES
setserialno 766133377
_mteTTable  0x736e6d70642e636f6e66 "dskTable" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "extTable" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "fileTable" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "laTable" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "memory" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "process table" 0x .0.0 0x 0x 600 0x 0x 0
_mteTTable  0x736e6d70642e636f6e66 "snmperrs" 0x .0.0 0x 0x 600 0x 0x 0
##############################################################
#
# snmpNotifyFilterTable persistent data
#
##############################################################
##############################################################
#
# ifXTable persistent data
#
ifXTable .1 14:0 18:0x $
ifXTable .2 14:0 18:0x $
##############################################################
engineBoots 1
oldEngineID 0x80001f88802738b6189b55865200000000

Une fois ceci fait, il faut dÃ©marrer le service snmp:

/etc/init.d/snmpd stop

Maintenant, on peut regarder le contenu du fichier /var/net-snmp/snmpd.conf pour CentOS/RedHat ou /var/lib/snmp/snmpd.conf pour Debian (note : seule la ligne qui nous intÃ©resse est reprise ici) :

...
usmUser 1 3 0x80001f88802738b6189b55865200000000 0x6374656d706c6500 0x6374656d706c6500 NULL .1.3.6.1.6.3.10.1.1.3 0xad9448213617c761438de6e81e0495931f690973 .1.3.6.1.6.3.10.1.2.4 0xd364fad3241bfcb2c2bbbe3736ab85d6 ""
...

Le fichier a automatiquement Ã©tÃ© modifiÃ© pour Ã©viter quâ€™une personne non autorisÃ©e puisse lire les deux mots de passe. Pour tester la configuration, il suffit de passer les options SNMPv3 en ligne de commande :

snmpwalk -v 3 -u ctemple -a SHA -A 'MonMot2Passe!!' -x AES -X '!!MaPhrase2PasseAE' -l authPriv localhost

Attention : les mots de passe contiennent des caractÃ¨res spÃ©ciaux qui peuvent Ãªtre interprÃ©tÃ©s par le SHELL. Il faut donc les encadrer par des simple quotes.

Et voilÃ ! SNMPv3 est configurÃ© sur votre serveur. Pour parfaire la configuration, penser Ã  dÃ©sactiver SNMPv1 et SNMPv2c en supprimant/commentant les lignes concernÃ©es dans le fichier /etc/snmp/snmpd.conf:

#rocommunity macommunaute
#rwcommunity macommunauteRW 192.168.0.1
syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%
rouser ctemple

Et Ã  redÃ©marrer le service SNMP:

/etc/init.d/snmpd restart



== Configuration avancÃ©e de SNMP sur Linux : envoi de trap SNMP
 

Le protocole SNMP nâ€™est pas dÃ©diÃ© Ã  fournir une rÃ©ponse Ã  des requÃªtes SNMP. Le protocole permet aussi dâ€™envoyer, sans avoir Ã©tÃ© sollicitÃ©, des informations Ã  un rÃ©cepteur. Ce mÃ©canisme est connu sous le nom dâ€™envoi de trap SNMP. Nous allons voir comment configurer lâ€™envoi de trap SNMP Ã  lâ€™aide de Net-SNMP vers un rÃ©cepteur donnÃ©.
Pourquoi envoyer des traps SNMP?

Le dÃ©mon SNMPd sâ€™auto-supervise. Comme nous lâ€™avons vu dans un article prÃ©cÃ©dent, il peut dÃ©tecter des Ã©tats anormaux de lâ€™Ã©quipement. Lorsquâ€™un comportement est anormal, il peut envoyer des traps SNMP. LÃ©gitimement, on peut se demander pourquoi est il important de mettre en place des traps SNMP alors quâ€™un outil de supervision dÃ©diÃ© est prÃ©sent et rÃ©alise des tests rÃ©currents. Les outils de supervision fonctionnent, gÃ©nÃ©ralement, sur le principe suivant: interrogation rÃ©currente de lâ€™Ã©quipement (par exemple Â« interrogation toutes les 5 minutes Â») pour obtenir des informations donnÃ©es. Lâ€™intervalle de test est gÃ©nÃ©ralement amplement suffisant (qui peut dire quâ€™il peut rÃ©pondre en moins dâ€™une minute Ã  toutes les pannes rencontrÃ©es? Vous? SÃ»r? MÃªme lorsque vous Ãªtes Ã  la machine Ã  cafÃ©, Ã  draguer la nouvelle stagiaire du service comptable qui ressemble beaucoup, par sa vivacitÃ© dâ€™esprit mammaire et son intelligence croupiale, Ã  la derniÃ¨re starlette de la tÃ©lÃ©-rÃ©alitÃ©? (tiens?!? que devient la premiÃ¨re starlette de la tÃ©lÃ©-rÃ©alitÃ©? Des nouvelles? Qui sâ€™Ã©tait dÃ©jÃ ?!?)â€¦ Brefâ€¦). Cependant, il est possible dâ€™amÃ©liorer la supervision sans avoir Ã  saturer le serveur de supervision en demandant aux Ã©quipements supervisÃ©s dâ€™envoyer des informations lorsquâ€™ils dÃ©tectent une panne. LÃ  est lâ€™intÃ©rÃªt des traps SNMP : envoyer des Â« alertes Â» dÃ¨s quâ€™une panne apparaÃ®t, sans avoir Ã  saturer le serveur de supervision. De plus, certaines informations sont plus simples Ã  rÃ©cupÃ©rer par des traps SNMP que par des requÃªtes. GÃ©nÃ©ralement, les traps SNMP sont plus faciles Ã  analyser quâ€™un indicateur agrÃ©gÃ© devant correspondre Ã  plusieurs requÃªtes SNMP dans plusieurs MIBs diffÃ©rentes.

Nous partons du fichier de configuration et de lâ€™utilisateur SNMPv3 prÃ©cÃ©dents (contenu du fichier /etc/snmp/snmpd.conf) :

syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%
rouser ctemple

Tout dâ€™abord, il faut ajouter une ligne permettant dâ€™indiquer quel rÃ©cepteur recevra les traps SNMP et quelle communautÃ© est utilisÃ©e:

informsink <ip> <communaute>

Par exemple, la ligne suivante permet de dÃ©clarer que lâ€™Ã©quipement 192.168.1.1 recevra nos traps SNMP avec la communautÃ© SNMP Â« secreteÂ« :

informsink 192.168.1.1 secrete

Ensuite, il faut dÃ©clarer si lâ€™on souhaite envoyer des traps SNMP lorsquâ€™une requÃªte SNMP reÃ§ue par cet Ã©quipement Ã©choue pour cause dâ€™erreur dâ€™authentification. Pour cela, il faut ajouter la directive suivante:

authtrapenable 1

Si vous ne souhaitez pas recevoir de traps SNMP lors dâ€™une erreur dâ€™authentification, il faut remplacer 1 (enabled) par 2 (disabled) :

authtrapenable 2

Remarque : par le passÃ©, je dÃ©sactivais systÃ©matiquement lâ€™envoi de traps SNMP lors dâ€™une erreur dâ€™authentification. La raison en Ã©tait simple : nous faisions changer les communautÃ©s SNMP sur tous les Ã©quipements. De ce fait, les outils de supervision prÃ©cÃ©demment mis en place et Â« oubliÃ©s Â» (oui, Ã§a arrive : des vieux Nagios 1.3/Cacti/MRTG/â€¦ traÃ®nent toujours sur beaucoup de systÃ¨mes dâ€™information et supervisent dans le vide pour rien) . Nous recevions alors beaucoup de traps SNMP inutiles dans la supervision Â« officielle Â». En dÃ©sactivant la fonctionnalitÃ©, le nombre dâ€™alertes diminue. Depuis, je me suis rendu compte quâ€™il est prÃ©fÃ©rableâ€¦ de supprimer lâ€™ancien outil de supervision devenu inutile ğŸ™‚

Le dÃ©mon Net-SNMP requiert un utilisateur SNMPv3 pour sâ€™auto-superviser. Il faut donc dÃ©clarer cet utilisateur. Nous avions crÃ©Ã© un utilisateur nommÃ© ctemple dans lâ€™article prÃ©cÃ©dent, nous pouvons donc le rÃ©utiliser:

agentSecName ctemple

Ensuite, nous allons dÃ©clarer la supervision par dÃ©faut. Celle-ci est dÃ©jÃ  suffisante et permet de superviser : la load, la swap, les partitions, lâ€™absence de processus, la taille des fichiers. Ceci se fait en ajoutant la directive :

defaultMonitors yes

Enfin, nous allons faire en sorte que lorsquâ€™une interface rÃ©seau est dÃ©connectÃ©e ou reconnectÃ©e, des traps SNMP soient envoyÃ©es.

linkUpDownNotifications yes

Une fois toutes les directives ajoutÃ©es, le fichier devient:

syscontact cedrictemple@cedrictemple.info
syslocation Europe/France/Paris/6 rue Beaubourg
load 16 8 4
includeAllDisks 10%
rouser ctemple
informsink 192.168.1.1 secrete
authtrapenable 1
agentSecName ctemple
defaultMonitors yes
linkUpDownNotifications yes

Il est alors possible de redÃ©marrer le service SNMP:

/etc/init.d/snmpd restart

Des trap SNMP seront alors automatiquement envoyÃ©es par le service SNMP de Net-SNMP lorsque des dÃ©passements de seuil auront lieu. Pour tester, vous pouvez simplement faire une requÃªte SNMP avec la mauvaise communautÃ© SNMP:

snmpwalk -v 2c -c badcommunnity IP

Vous recevrez alors des traps SNMP sur le rÃ©cepteur de trap SNMP:

tail -f /var/log/messages
2013-11-21T21:36:50.829966+01:00 localhost snmptrapd[1921]: 2013-11-21 21:36:50 localhost.localdomain [UDP: [127.0.0.1]:60228]:#012DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (11405) 0:01:54.05#011SNMPv2-MIB::snmpTrapOID.0 = OID: SNMPv2-MIB::authenticationFailure#011SNMPv2-MIB::snmpTrapEnterprise.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
2013-11-21T21:36:51.830362+01:00 localhost snmpd[2985]: Connection from UDP: [127.0.0.1]:42847
2013-11-21T21:36:51.832737+01:00 localhost snmptrapd[1921]: 2013-11-21 21:36:51 localhost.localdomain [UDP: [127.0.0.1]:60228]:#012DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (11506) 0:01:55.06#011SNMPv2-MIB::snmpTrapOID.0 = OID: SNMPv2-MIB::authenticationFailure#011SNMPv2-MIB::snmpTrapEnterprise.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
2013-11-21T21:36:52.831201+01:00 localhost snmpd[2985]: Connection from UDP: [127.0.0.1]:42847
2013-11-21T21:36:52.833210+01:00 localhost snmptrapd[1921]: 2013-11-21 21:36:52 localhost.localdomain [UDP: [127.0.0.1]:60228]:#012DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (11606) 0:01:56.06#011SNMPv2-MIB::snmpTrapOID.0 = OID: SNMPv2-MIB::authenticationFailure#011SNMPv2-MIB::snmpTrapEnterprise.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10

Remarque : sur Debian, lors du redÃ©marrage de lâ€™agent SNMP, vous pourrez avoir des erreurs dans le fichier de log /var/log/syslog :

Nov 27 09:05:41 debian snmpd[22637]: payload OID: prNames
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: Unknown payload OID: prNames
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: Unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: payload OID: prErrMessage
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: Unknown payload OID: prErrMessage
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: Unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: trigger OID: prErrorFlag
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: unknown monitor OID
Nov 27 09:05:41 debian snmpd[22637]: payload OID: memErrorName
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: Unknown payload OID: memErrorName
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: Unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: payload OID: memSwapErrorMsg
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: unknown payload OID
Nov 27 09:05:41 debian snmpd[22637]: Unknown payload OID: memSwapErrorMsg
Nov 27 09:05:41 debian snmpd[22637]: /etc/snmp/snmpd.conf: line 13: Error: Unknown payload OID

Cela est liÃ© Ã  lâ€™absence des MIBs de base car celles-ci ne peuvent pas Ãªtre incluses dans Debian du fait de leur licence qui nâ€™est pas compatible avec celle de Debian. Pour rÃ©soudre ce problÃ¨me, il vous faut les tÃ©lÃ©charger. Heureusement, un paquet existe pour cela mais il nâ€™est disponible que dans le dÃ©pÃ´t non-free. Il faut modifier le fichier /etc/apt/sources.list pour ajouter non-free en fin de ligne:

deb http://mirrors.ircam.fr/pub/debian/ squeeze main non-free
deb http://security.debian.org/ squeeze/updates main non-free
deb http://mirrors.ircam.fr/pub/debian/ squeeze-updates main non-free

Une fois ceci fait, on peut installer le paquet snmp-mibs-downloader:

apt-get update
apt-get install snmp-mibs-downloader

Editer le fichier /etc/default/snmpd et modifier la ligne concernÃ©e pour aboutir au rÃ©sultat suivant:

export MIBS=UCD-SNMP-MIB

RedÃ©marrer le service Net-SNMP:

/etc/init.d/snmpd restart

== Configuration de base de SNMPD

 

Comment configurer le dÃ©mon SNMPd de Net-SNMP afin quâ€™il rÃ©ponde Ã  nos requÃªtes? Nous verrons dans un second temps sa configuration avancÃ©e qui nous permettra dâ€™envoyer des requÃªtes SNMP en cas de panne ou de redÃ©marrer des services Ã  distance. Mais voyons tout dâ€™abord son utilisation basique. En effet, il est important de savoir que le fichier de configuration de SNMPd peut Ãªtre trÃ¨s complexe. Sa configuration par dÃ©faut lâ€™est dâ€™ailleurs. Si vous regardez le fichier de configuration fourni par votre distribution Linux prÃ©fÃ©rÃ©e, vous verrez quâ€™il est possible de dÃ©finir des accessgroup, des views et autres subtilitÃ©s. Je vous invite Ã  partir dâ€™un fichier vide. Ses fonctionnalitÃ©s (view, accessgroup, â€¦) sont assez peu utilisÃ©es en pratique. Elles sont relativement complexes Ã  mettre en oeuvre pour un apport nÃ©gligeable : peu de monde Ã  besoin de filtrer les accÃ¨s aux diffÃ©rents OIDs. En gÃ©nÃ©ral, câ€™est du Â« tout ou rien Â» : soit vous avez accÃ¨s Ã  tous les OIDs, soit vous nâ€™avez accÃ¨s Ã  rien. Il est peu probable que des personnes diffÃ©rentes ou des groupes de personnes diffÃ©rentes utilisent SNMP : câ€™est en effet le domaine des administrateurs des Ã©quipements. La seule subtilitÃ©, que nous allons voir dâ€™ailleurs, correspond au filtrage sur lâ€™accÃ¨s en lecture ou en Ã©criture.

Tout dâ€™abord, il faut se rendre dans le rÃ©pertoire de configuration de SNMP:

 cd /etc/snmp
 mv snmpd.cond snmpd.conf.ori
 vim snmpd.conf

Une fois le fichier dâ€™origine sauvegardÃ©, vous pouvez partir dâ€™un fichier vide. La premiÃ¨re ligne de ce fichier va vous permettre de saisir la communautÃ© accessible en lecture seule:

 rocommunity macommunaute

DÃ¨s lors, vous pourrez interroger votre agent SNMPd avec la communautÃ© Â« macommunaute Â». Vous pouvez augmenter la sÃ©curitÃ© en ajoutant la source autorisÃ©e Ã  vous interroger:

 rocommunity macommunaute 192.168.0.1

DÃ¨s lors, seule lâ€™adresse IP 192.168.0.1 sera autorisÃ©e Ã  vous interroger avec la communautÃ© correspondante. Cela ajoute (un peu) de sÃ©curitÃ© en autorisant seulement le serveur de supervision Ã  rÃ©cupÃ©rer les informations.

Vous pouvez ajouter une communautÃ© accessible en lecture et Ã©criture en utilisant rwcommunity en lieu et place de rocommunity. Attention, vous ne devez pas utiliser la mÃªme communautÃ© pour les lignes rocomunity et rwcommunity (câ€™est en effet un non sens : une communautÃ© ne peut pas Ãªtre Ã  la fois en read-only et en read/write). En gÃ©nÃ©ral, on met une communautÃ© en Read-Only et une communautÃ© diffÃ©rente en Read/Write.

Ensuite, il vous faut mettre les informations administratives. Ces informations nâ€™ont pas vraiment une grande utilitÃ© mais je les utilise personnellement pour renseigner lâ€™adresse Ã  laquelle contacter les administrateurs et la localisation de mes Ã©quipements. Je prends une politique de nommage afin de dÃ©couper la localisation en diffÃ©rentes parties afin de les rÃ©utiliser dans diffÃ©rentes cartes. Exemple:

syscontact admin@masociete.com
syslocation Europe/France/Paris/6 rue Beaubourg/Salle 3/Baie 4

Le fichier de configuration final :

 rocommunity macommunaute
 rocommunity macommunauteRW 192.168.0.1
 syscontact admin@masociete.com
 syslocation Europe/France/Paris/6 rue Beaubourg/Salle 3/Baie 4

Une fois ceci fait, vous pouvez redÃ©marrer lâ€™agent SNMP et faire quelques tests pour vÃ©rifier quâ€™il fonctionne correctement :

/etc/snmp/snmpd restart
snmpwalk -v 2c -c macommunaute <ip>
