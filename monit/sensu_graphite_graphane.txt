== notes sensu_graphite_grafana ==


1/ graphite 
On installe les packages 

ubuntu@SensuServer:~$ sudo apt-get install graphite-web graphite-carbon

Attention : on ne supprime pas la conf au pop up : à l'install 

on deploie la conf db : 

ubuntu@SensuServer:~$ sudo graphite-manage syncdb
/usr/lib/python2.7/dist-packages/graphite/settings.py:249: UserWarning: SECRET_KEY is set to an unsafe default. This should be set in local_settings.py for better security
  warn('SECRET_KEY is set to an unsafe default. This should be set in local_settings.py for better security')
Operations to perform:
  Synchronize unmigrated apps: account, cli, render, whitelist, metrics, url_shortener, dashboard, composer, events, browser
  Apply all migrations: admin, contenttypes, tagging, auth, sessions
Synchronizing apps without migrations:
  Creating tables...
    Creating table account_profile
    Creating table account_variable
    Creating table account_view
    Creating table account_window
    Creating table account_mygraph
    Creating table dashboard_dashboard
    Creating table events_event
    Creating table url_shortener_link
    Running deferred SQL...
  Installing custom SQL...
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying sessions.0001_initial... OK
  Applying tagging.0001_initial... OK

You have installed Django's auth system, and don't have any superusers defined.
Would you like to create one now? (yes/no): yes
Username (leave blank to use 'root'): 
Email address: root@test.com
Password: 
Password (again): 
Superuser created successfully.

on cree donc un user/mdp et adresse mail.

- config de carbon : 

On configure le service carbon-cache au boot du server :

-
ubuntu@SensuServer:~$ sudo cat /etc/default/graphite-carbon
# Change to true, to enable carbon-cache on boot
CARBON_CACHE_ENABLED=true

- modification de la retention des données stockées dans carbon :
ubuntu@SensuServer:~$ sudo cat /etc/carbon/storage-schemas.conf 
# Schema definitions for Whisper files. Entries are scanned in order,
# and first match wins. This file is scanned for changes every 60 seconds.
#
#  [name]
#  pattern = regex
#  retentions = timePerPoint:timeToStore, timePerPoint:timeToStore, ...

# Carbon's internal metrics. This entry should match what is specified in
# CARBON_METRIC_PREFIX and CARBON_METRIC_INTERVAL settings
[carbon]
pattern = ^carbon\.
retentions = 60:90d

[default_1min_for_1day]
pattern = .*
#retentions = 60s:1d  <<< on change donc le polling pour les données arrivant dans carbon 
retentions = 5s:1d,1m:30d

- Demarrage du service carbon-cache :
ubuntu@SensuServer:~$ sudo service carbon-cache start

- install et config du serveur web : 

ubuntu@SensuServer:~$ sudo apt-get install apache2 libapache2-mod-wsgi
copie du vhost d'origine : 
ubuntu@SensuServer:~$ sudo cp /usr/share/graphite-web/apache2-graphite.conf /etc/apache2/sites-available/
Activation du vhost : 
ubuntu@SensuServer:~$ sudo a2ensite apache2-graphite
Enabling site apache2-graphite.
To activate the new configuration, you need to run:
  service apache2 reload
ubuntu@SensuServer:~$ sudo service apache2 reload

ubuntu@SensuServer:~$ sudo a2dissite 000-default.conf 
Site 000-default disabled.
To activate the new configuration, you need to run:
  service apache2 reload
ubuntu@SensuServer:~$ sudo service apache2 reload

Modification des droits sur les fichiers d'execution : 
ubuntu@SensuServer:~$ sudo chmod 666 /var/lib/graphite/graphite.db
ubuntu@SensuServer:~$ sudo chmod 755 /usr/share/graphite-web/graphite.wsgi 

ubuntu@SensuServer:~$ sudo service apache2 restart

On peut desormais ouvrir un navigateur et consulter le frontend graphite :

a noter que si on utilise une vm vagrant une redirection de port peut être faite pour le web ( verifier le Vagrantfile et modifier si besoin ) 

http://127.0.0.1:8080/


On va ajouter des plugins pour grapher les  charges et network :
pour se faire  il nous faut installer ruby puis des gems dediés :

root@SensuServer:~# apt install ruby
root@SensuServer:~# gem install sensu-plugins-load-checks
root@SensuServer:~# gem install sensu-plugins-network-checks


Injection de données dans graphite  :

on va dans sensu creer un check metric qu'on va donc diriger vers graphite :

root@SensuServer:/etc/sensu/conf.d# cat check_metrics.json 
{
  "checks": {
    "load_metrics": {
      "type": "metric",
      "command": "metrics-load.rb",
      "interval": 5,
      "subscribers": ["Production"],
      "handlers": ["handler_graphite"]  
     },
    "net_metrics": {
      "type": "metric",
      "command": "metrics-net.rb",
      "interval": 5,
      "subscribers": ["Production"],
      "handlers": ["handler_graphite"]  
     }

  }
}


