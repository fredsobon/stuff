=== notes tp prometheus : ====




activation d'une metrique du node exporter desactivé par défaut 

.


ajout d'une machine a monitorer :

on ajoute dans le fichier de conf prometheus.yml 

- job_name: node_exporter
  static_configs:
  - targets:
    - 10.121.253.78:9100



de base prometheus ecrit ses data en local : il ne pousse pas dans s3 par exemple.
Il y a des projets tierce pour stocker ( ex thanos) .

La base est une resolution de 15s avec un max de 15jours de retention.


-service discovery :

prometheus va inerroger quelque chose pour recup la listes des objects qu'il va scraper .


dns_sd_configs



on va modifier nsd : serveur dns  local autoritaire ( pas de fwd) :w




cat /etc/resolv.conf
; Created by cloud-init on instance boot automatically, do not edit.
;
; generated by /usr/sbin/dhclient-script
search lapin.io
nameserver 127.0.0.1
#nameserver 10.101.1.227
#nameserver 10.101.101.49
#nameserver 10.120.1.227


on ajoute a la fin dans le fichier nsd.conf notre domaine de test :

zone:
  name: lab.lapin.io
  zonefile: lab.lapin.io.conf


on va ajouter le fichier de zone : 

[root@poc-prometheus-server-fso prometheus-2.18.1.linux-amd64]# cat /etc/nsd/lab.lapin.io.conf
;## NSD authoritative only DNS

$ORIGIN lab.lapin.io.    ; default zone domain
$TTL 86400           ; default time to live

@ IN SOA ns1 admin@lab.lapin.io (
           2012082703  ; serial number
           28800       ; Refresh
           14400        ; Retry
           864000      ; Expire
           86400       ; Min TTL
           )

           NS      ns1.lab.lapin.io.
           NS      ns2.lab.lapin.io.

virt02u   	   IN     A    10.121.253.1
virt04u   	   IN     A    10.121.253.2
virt06u   	   IN     A    10.121.235.3


FSO-node       IN     A    10.121.253.78

_pve._tcp      SRV    0 0 8006 FSO-node

_node._tcp     SRV   0 0 9100 FSO-node
_pve._tcp      SRV    0 0 8006 virt02u.lab.lapin.io.
_pve._tcp      SRV    0 0 8006 virt04u.lab.lapin.io.
_pve._tcp      SRV    0 0 8006 virt06u.lab.lapin.io.

;## NSD authoritative only DNS

maintenant on modifie la conf prometheus en ajoutant le service discovery :

scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
    - targets: ['localhost:9090']

  - job_name: 'node_exporter'
    dns_sd_configs:
    - names :
      - _node._tcp.lab.lapin.io

>> on aura maintenant une decouverte des servers service entrés dans la conf dns :

_node._tcp     SRV   0 0 9100 bob-node

- prometheus evalue les rules : les seuils une fois que le seuil est dépassé il envoit a alerte manager qui lui va envoyé a slack etc ... : alerte manager ne sert juste qu'a l'aiguillage 

- prometheus devient un standart : les applis exposent les metriques au format prometheus.
on peut creer un fichier text a plat qui recupére ls datas au format prometheus
text_file 

les fichiers doivent finir par .prom

